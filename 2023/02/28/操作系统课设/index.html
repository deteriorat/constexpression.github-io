<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="ConstExpression&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      操作系统课设 | Constexpression&#39;s blog
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
    
<script src="/js/local-search.js"></script>


<meta name="generator" content="Hexo 6.3.0"></head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Constexpression's blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
        <li class="menu-item menu-item-search right-list">
    <a role="button" class="popup-trigger">
        <i class="fa fa-search fa-fw"></i>
    </a>
</li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
      <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off"
                    placeholder="Please enter your keyword(s) to search." spellcheck="false"
                    type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>操作系统课设</h2>
  <p class="post-date">2023-02-28</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h3 id><a href="#" class="headerlink" title></a></h3><h3 id="Lab1-challenge1-打印用户程序调用栈"><a href="#Lab1-challenge1-打印用户程序调用栈" class="headerlink" title="Lab1_challenge1 打印用户程序调用栈"></a>Lab1_challenge1 <strong>打印用户程序调用栈</strong></h3><p>在main函数中调用了多层函数。需要打印栈的情况。</p>
<h4 id="相关知识："><a href="#相关知识：" class="headerlink" title="相关知识："></a>相关知识：</h4><p>代理内核的启动过程</p>
<p>重点在于理解lab1中进程的定义。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span> <span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">process</span> &#123;</span><br><span class="line"><span class="number">20</span>   <span class="comment">// pointing to the stack used in trap handling.</span></span><br><span class="line"><span class="number">21</span>   uint64 kstack;</span><br><span class="line"><span class="number">22</span>   <span class="comment">// trapframe storing the context of a (User mode) process.</span></span><br><span class="line"><span class="number">23</span>   trapframe* trapframe;</span><br><span class="line"><span class="number">24</span> &#125;process;</span><br></pre></td></tr></table></figure>

<p>包含栈指针和指向trapframe的指针。trapframe中包含寄存器regs，里面存了我们所需要的fp。</p>
<p>elf_fpread函数需要一个ctx变量。ctx是什么？elf.h文件里有定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf_ctx_t</span> &#123;</span></span><br><span class="line">  <span class="type">void</span> *info;</span><br><span class="line">  elf_header ehdr;</span><br><span class="line">&#125; elf_ctx;</span><br></pre></td></tr></table></figure>

<p>在elf_init函数里面对ctx进行了初始化。由此可以得到elf_header</p>
<p>然后就是根据手册里面的指导读取所有的section table。得到symtab和strtab</p>
<p>打印的symtab.value和其name在strtab偏移量中的字符串取值如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 81000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 81000398</span><br><span class="line">systab名字</span><br><span class="line">st_value 810003c4</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字app_print_backtrace.c</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字user_lib.c</span><br><span class="line">st_value 00000000</span><br><span class="line">systab名字snprintf.c</span><br><span class="line">st_value 81000190</span><br><span class="line">systab名字vsnprintf</span><br><span class="line">st_value 81000016</span><br><span class="line">systab名字f7</span><br><span class="line">st_value 8100003e</span><br><span class="line">systab名字f5</span><br><span class="line">st_value 8100016a</span><br><span class="line">systab名字print_backtrace</span><br><span class="line">st_value 81000066</span><br><span class="line">systab名字f3</span><br><span class="line">st_value 8100007a</span><br><span class="line">systab名字f2</span><br><span class="line">st_value 810000a2</span><br><span class="line">systab名字main</span><br><span class="line">st_value 810000ca</span><br><span class="line">systab名字do_user_call</span><br><span class="line">st_value 81000000</span><br><span class="line">systab名字f8</span><br><span class="line">st_value 81000052</span><br><span class="line">systab名字f4</span><br><span class="line">st_value 8100008e</span><br><span class="line">systab名字f1</span><br><span class="line">st_value 810000e2</span><br><span class="line">systab名字printu</span><br><span class="line">st_value 81000144</span><br><span class="line">systab名字exit</span><br><span class="line">st_value 8100002a</span><br><span class="line">systab名字f6</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>此外，可以通过对current-&gt;trapframe-&gt;regs.s0循环查询函数调用栈。从中可以找到不同栈的fp和ra。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">regs.s0:810fff60</span><br><span class="line">	ra:8100000e</span><br><span class="line">fp:810fff80</span><br><span class="line">	ra:81000036</span><br><span class="line">fp:810fff90</span><br><span class="line">	ra:8100004a</span><br><span class="line">fp:810fffa0</span><br><span class="line">	ra:8100005e</span><br><span class="line">fp:810fffb0</span><br><span class="line">	ra:81000072</span><br><span class="line">fp:810fffc0</span><br><span class="line">	ra:81000086</span><br><span class="line">fp:810fffd0</span><br><span class="line">	ra:8100009a</span><br><span class="line">fp:810fffe0</span><br><span class="line">	ra:810000ba</span><br></pre></td></tr></table></figure>

<p>可以发现ra和value存在对应关系。</p>
<p>有一个问题，81000000对应的有一个空字符串…所以需要特判st_info字段是否为18(FUNC宏定义)。为18时代表这个字段是有意义的。至于为什么是18….百度..一下。很多信息藏在<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man5/elf.5.html">elf(5) - Linux manual page (man7.org)</a>里面。</p>
<p><img src="/2023/02/28/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E8%AE%BE/Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230303205923034.png" alt="image-20230303205923034"></p>
<h3 id="Lab1-challenge2-打印异常代码行"><a href="#Lab1-challenge2-打印异常代码行" class="headerlink" title="Lab1_challenge2 打印异常代码行"></a>Lab1_challenge2 打印异常代码行</h3><p>目标：内核能够输出触发异常的用户程序的源文件名和对应代码行</p>
<p>elf.c中给出了debug_line段的解析函数make_addr_line。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make_addr_line(elf_ctx *ctx, <span class="type">char</span> *debug_line, uint64 length)</span><br></pre></td></tr></table></figure>

<p>elf文件中名为.debug_line的段保存到缓冲区中，然后将缓冲区指针传入这个参数；length为.debug_line段数据的长度。</p>
<p>函数调用结束后，process结构体的dir、file、line三个指针会各指向一个数组。</p>
<p>dir数组存储</p>
<p>所有代码文件的文件夹路径字符串指针</p>
<p>file数组存储所有代码文件的文件名字符串指针以及其文件夹路径在dir数组中的索引</p>
<p>file数组存储所有代码文件的文件名字符串指针以及其文件夹路径在dir数组中的索引</p>
<p>为完成该挑战，需要利用用户程序编译时产生的<strong>调试信息</strong>，目前最广泛使用的调试信息格式是DWARF</p>
<p>在lab1_challenge1中我们还可以得到elf文件中各个段的名字。可以发现.debug_line段就在其中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">section名字</span><br><span class="line">section名字.text</span><br><span class="line">section名字.rodata.str1.8</span><br><span class="line">section名字.rodata</span><br><span class="line">section名字.debug_info</span><br><span class="line">section名字.debug_abbrev</span><br><span class="line">section名字.debug_aranges</span><br><span class="line">section名字.debug_line</span><br><span class="line">section名字.debug_str</span><br><span class="line">section名字.comment</span><br><span class="line">section名字.riscv.attributes</span><br><span class="line">section名字.debug_frame</span><br><span class="line">section名字.debug_loc</span><br><span class="line">section名字.debug_ranges</span><br><span class="line">section名字.symtab</span><br><span class="line">section名字.strtab</span><br><span class="line">section名字.shstrtab</span><br></pre></td></tr></table></figure>

<p>所以我们先参照前面的方法读取出debuf_line段的地址，再调用解析函数make_addr_line。</p>
<p>得到的三个数组按道理是存在process结构体里面，但是我查找process.h文件没有发现有这些东西。实际上该函数里面的做法如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">make_addr_line</span><span class="params">(elf_ctx *ctx, <span class="type">char</span> *debug_line, uint64 length)</span> &#123;</span><br><span class="line">   process *p = ((elf_info *)ctx-&gt;info)-&gt;p;</span><br><span class="line">    p-&gt;debugline = debug_line;</span><br><span class="line">    <span class="comment">// directory name char pointer array</span></span><br><span class="line">    p-&gt;dir = (<span class="type">char</span> **)((((uint64)debug_line + length + <span class="number">7</span>) &gt;&gt; <span class="number">3</span>) &lt;&lt; <span class="number">3</span>); <span class="type">int</span> dir_ind = <span class="number">0</span>, dir_base;</span><br><span class="line">    <span class="comment">// file name char pointer array</span></span><br><span class="line">    p-&gt;file = (code_file *)(p-&gt;dir + <span class="number">64</span>); <span class="type">int</span> file_ind = <span class="number">0</span>, file_base;</span><br><span class="line">    <span class="comment">// table array</span></span><br><span class="line">    p-&gt;line = (addr_line *)(p-&gt;file + <span class="number">64</span>); p-&gt;line_ind = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>所以我们仿照这个做法试试。</p>
<p>注意，还是要把两个函数声明在elf.h头文件中供其他调用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uint64 <span class="title function_">elf_fpread</span><span class="params">(elf_ctx *ctx, <span class="type">void</span> *dest, uint64 nb, uint64 offset)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">make_addr_line</span><span class="params">(elf_ctx *ctx, <span class="type">char</span> *debug_line, uint64 length)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>问题：make_addr_line的第二个参数是 char *指针类型，而我们定义的指向.debug_line段数据的指针是Elf64_Shdr类型的…所以强转看看。</p>
<p>还有elf_info这个结构体也没有定义。定义在elf.c中。把它移到.h中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">elf_info_t</span> &#123;</span></span><br><span class="line">  <span class="type">spike_file_t</span> *f;</span><br><span class="line">  process *p;</span><br><span class="line">&#125; elf_info;</span><br></pre></td></tr></table></figure>

<p>不能直接移。需要链接到spike.h。。。。md</p>
<p>发现一个问题。如果直接运行，结果是<strong>illegal instruction</strong>，这是正常的。</p>
<p>换成访问process里面的东西的时候就变成了<strong>Load access fault!</strong></p>
<p>原来process_t里面的结构被改了，变成下面的样子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// the extremely simple definition of process, used for begining labs of PKE</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">process_t</span> &#123;</span></span><br><span class="line">  <span class="comment">// pointing to the stack used in trap handling.</span></span><br><span class="line">  uint64 kstack;</span><br><span class="line">  <span class="comment">// trapframe storing the context of a (User mode) process.</span></span><br><span class="line">  trapframe* trapframe;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// added @lab1_challenge2</span></span><br><span class="line">  <span class="type">char</span> *debugline; <span class="type">char</span> **dir; code_file *file; addr_line *line; <span class="type">int</span> line_ind;</span><br><span class="line">&#125;process;</span><br></pre></td></tr></table></figure>

<p>其中code_file以及addr_line的定义又如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// code file struct, including directory index and file name char pointer</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    uint64 dir; <span class="type">char</span> *file;</span><br><span class="line">&#125; code_file;</span><br><span class="line"></span><br><span class="line"><span class="comment">// address-line number-file name table</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    uint64 addr, line, file;</span><br><span class="line">&#125; addr_line;</span><br></pre></td></tr></table></figure>



<p>在读到缓冲区的时候出现misaligned load的错误…要定义在.h文件里面…</p>
<p>…数组要开8000+   “那么这个数组必须足够大”</p>
<p>打开文件的时候不能用fopen，而应该用spike_file里面的<strong>spike_file_open</strong>。相应的，FILE文件应该用spike_file_t*</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> kfd;  <span class="comment">// file descriptor of the host file</span></span><br><span class="line">  uint32 refcnt;</span><br><span class="line">&#125; <span class="type">spike_file_t</span>;</span><br></pre></td></tr></table></figure>

<p>没有strcat函数…</p>
<p>…麻</p>
<h3 id="lab2-challenge2-堆空间管理"><a href="#lab2-challenge2-堆空间管理" class="headerlink" title="lab2_challenge2 堆空间管理"></a>lab2_challenge2 堆空间管理</h3><p>这是碰都不能碰的滑梯.jpg</p>
<p>申请100和50个字节的一个物理页的内存，然后使用better_free释放掉100个字节，向50个字节中复制一串字符串，进行输出。原本的pke中malloc的实现是非常简化的（一次直接分配一个页面），你的挑战任务是<strong>修改内核(包括machine文件夹下)的代码，使得应用程序的malloc能够在一个物理页中分配，并对各申请块进行合理的管理</strong>。</p>
<p>首先要做的当然是在顺着系统调用的次序逐步跟随malloc和free找到userlib和syscall中对应的代码，然后将前者改为better_malloc和better_free。改完之后自然是实现。原来的实现是直接调用user_vm_map和user_vm_unmap进行映射，所以我们找到vmm.h，在其中加入user_better_free和user_better_malloc函数。</p>
<p>执行过程中要用到current，所以还要include process.h</p>
<h3 id="lab3-challenge2-实现信号量"><a href="#lab3-challenge2-实现信号量" class="headerlink" title="lab3_challenge2 实现信号量"></a>lab3_challenge2 实现信号量</h3><p>简单来说就是在user_lib和syscall里面实现sem_new, sem_P, sem_V操作。</p>
<p>sem_new(n)：找到一个未被占用的信号量，初值设置为n</p>
<p>sem_P(n)：对编号为n的信号量执行P操作。还需要进行进程调度。维护一个等待队列。</p>
<p>sem_V(n)：同理。</p>
<p>需要添加的工作是：</p>
<p>在process中添加init_sem_pool（参考线程池），并声明信号灯数组。注意，信号池和线程池的初始化需要在kernel.c里面一起实现。</p>
<p>然后参照系统调用的步骤在userlib、kernel和syscall里面加上三个函数的调用实现。</p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#笔记" >
    <span class="tag-code">笔记</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2023/02/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%A4%8D%E4%B9%A0/">
        <span class="nav-arrow">← </span>
        
          操作系统复习
        
      </a>
    
    
      <a class="nav-right" href="/2023/03/20/%E7%94%9F%E6%B4%BB%E7%A2%8E%E7%89%87/">
        
          生活碎片
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">扫描二维码，分享此文章</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo=""
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link"><span class="toc-nav-text"></span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Lab1-challenge1-%E6%89%93%E5%8D%B0%E7%94%A8%E6%88%B7%E7%A8%8B%E5%BA%8F%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-nav-text">Lab1_challenge1 打印用户程序调用栈</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A"><span class="toc-nav-text">相关知识：</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Lab1-challenge2-%E6%89%93%E5%8D%B0%E5%BC%82%E5%B8%B8%E4%BB%A3%E7%A0%81%E8%A1%8C"><span class="toc-nav-text">Lab1_challenge2 打印异常代码行</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#lab2-challenge2-%E5%A0%86%E7%A9%BA%E9%97%B4%E7%AE%A1%E7%90%86"><span class="toc-nav-text">lab2_challenge2 堆空间管理</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#lab3-challenge2-%E5%AE%9E%E7%8E%B0%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="toc-nav-text">lab3_challenge2 实现信号量</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://example.com/2023/02/28/操作系统课设/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>






    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2023 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
    
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>